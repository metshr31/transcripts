name: Record & Transcribe (HLS) / call

on:
  workflow_dispatch:

jobs:
  capture-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install chromium

      - name: Capture manifest with Playwright
        working-directory: .github
        env:
          OUT_DIR: out
          PAGE_URL: https://event.webcasts.com/starthere.jsp?ei=1732689&tp_key=88708506b9&tp_special=8
        run: |
          set -euo pipefail
          mkdir -p "$OUT_DIR"
          python scripts/capture_manifest.py --url "$PAGE_URL" --out "$OUT_DIR"
          echo "Captured files in $OUT_DIR:"
          ls -la "$OUT_DIR"

      - name: Email results via Yahoo
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.yahoo.com
          server_port: 465          # SSL
          secure: true
          username: ${{ secrets.YAHOO_EMAIL }}
          password: ${{ secrets.YAHOO_APP_PASSWORD }}
          from: ${{ secrets.YAHOO_EMAIL }}
          to: ${{ secrets.TO_EMAIL }}
          subject: "HLS Manifest Capture — ${{ github.repository }} — run #${{ github.run_number }}"
          body: |
            Captured files are attached.
            Repo: ${{ github.repository }}
            Run ID: ${{ github.run_id }}
            Commit: ${{ github.sha }}
          attachments: .github/out/*